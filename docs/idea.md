はい、承知いたしました。
これまでの対話を基に、VS Code拡張機能として開発する「AIクルーによる自律型ソフトウェア開発プラットフォーム」の要件定義書を作成します。

---

## **要件定義書: CrewAI Connect for VS Code**

**文書バージョン:** 1.0  
**作成日:** 2025年7月15日  
**作成者:** Gemini

### **1. 概要**

#### **1.1. プロジェクト名**
CrewAI Connect for VS Code

#### **1.2. 背景と目的**
ソフトウェア開発における反復的なタスクや定型的なコーディングは、依然として開発者の多くの時間を消費している。一方で、CrewAIのような自律型AIエージェントフレームワークや、VS Codeに統合された大規模言語モデル（LLM）は、これらのタスクを自動化する大きな可能性を秘めている。
本プロジェクトの目的は、開発者が日常的に使用するVS Code環境内に、自律型AI開発チームをシームレスに統合することである。これにより、開発者は高レベルの指示を与えるだけで、要件定義からコーディング、テストまでのプロセスを自動化し、生産性を飛躍的に向上させ、より創造的な作業に集中できる環境を実現する。

#### **1.3. 開発するプロダクトの概要**
本プロダクトは、Visual Studio Codeの拡張機能として提供される。ユーザーがチャットインターフェースを通じて開発タスクを指示すると、バックグラウンドで動作するAIエージェントのチーム（AIクルー）が、ユーザーの現在のワークスペース内で自律的にタスクを遂行する。
最大の特徴は、AIの思考エンジンとしてVS Codeの`vscode.lm` APIを利用することである。これにより、ユーザーは別途APIキーを設定することなく、自身が利用中のIDEネイティブAI（例：GitHub Copilot）の能力をAIクルーに付与できる。

#### **1.4. ターゲットユーザー**
*   日々のコーディング業務を効率化したいすべてのソフトウェア開発者。
*   新しい技術やフレームワークの雛形を迅速に作成したい開発者。
*   AIによる開発自動化に興味を持つ先進的な技術者。

#### **1.5. スコープ（対象範囲と対象外）**
*   **対象範囲:**
    *   VS Code拡張機能の開発と配布。
    *   チャットベースのUIによるタスク指示機能。
    *   ファイル/ディレクトリの生成、読み取り、更新、削除。
    *   `vscode.lm` APIを介したLLMとの連携。
    *   統合ターミナルを利用したコマンド（依存関係のインストール、テスト実行など）の自動実行。
    *   AIクルーのタスク進捗のリアルタイム表示。
*   **対象外:**
    *   VS Code以外のIDEのサポート。
    *   AIクルー自体のロジック開発（オープンソースのCrewAIフレームワークを利用）。
    *   複雑なGUIアプリケーションの自動生成。
    *   デプロイ先のクラウドインフラのプロビジョニング。
    *   LLMそのものの開発。

### **2. 機能要件**

#### **2.1. ユーザーインターフェース (UI)**
| ID | 機能名 | 詳細 |
| :--- | :--- | :--- |
| UI-01 | **CrewAIサイドバー** | VS Codeのアクティビティバーに専用アイコンを設置する。クリックするとメインパネルが表示される。 |
| UI-02 | **タスク開始ボタン** | サイドバーパネルに配置し、クリックすると新しいタスクを開始するためのチャットWebviewを開く。 |
| UI-03 | **チャットWebview** | ユーザーが自然言語でAIに指示を入力するためのインターフェース。AIからの質問や計画の提示、最終報告もここに表示される。 |
| UI-04 | **進捗トラッカー** | サイドバーパネルに表示。現在どのAIエージェントが、どのタスクを実行中かをリアルタイムでリスト表示する。（例: `[Coder AI] app.pyの実装`） |
| UI-05 | **計画承認/拒否ボタン** | AIが提示した開発計画に対して、ユーザーが実行を許可または拒否するためのボタンをチャットWebview内に表示する。 |
| UI-06 | **通知機能** | タスクの完了、エラー発生、ユーザーの確認が必要な際に、VS Code標準の通知機能（Information/Error Message）を用いてユーザーに知らせる。 |

#### **2.2. コア機能**
| ID | 機能名 | 詳細 |
| :--- | :--- | :--- |
| CORE-01 | **タスク指示機能** | ユーザーはチャットWebviewから、自然言語で開発したい内容（例: 「Flaskで簡単なAPIを作って」）を指示できる。 |
| CORE-02 | **自律開発機能** | 指示を受け、バックエンドのAIクルー（Planner, Coder, Tester等）が自律的にタスクを分解し、計画を立て、ファイル操作やコマンド実行を遂行する。 |
| CORE-03 | **LLM連携機能** | AIエージェントの思考プロセスには`vscode.lm` APIを利用する。拡張機能はPythonのAIエンジンからの要求を仲介し、LLMとの対話結果を返す。 |
| CORE-04 | **ファイルシステム連携** | AIクルーは現在のVS Codeワークスペース内のファイルを読み書きできる。これにより、既存プロジェクトへの機能追加やリファクタリングも可能になる。 |
| CORE-05 | **ターミナル連携** | AIクルーはVS Codeの統合ターミナルを起動し、必要なコマンド（例: `npm install`, `pytest`）を自動で実行できる。 |
| CORE-06 | **コンテキスト認識** | ユーザーからの指示に加え、現在開いているファイルやプロジェクトの構造をコンテキストとしてAIに提供し、より精度の高い応答を生成する。 |

### **3. 非機能要件**

| ID | 項目 | 詳細 |
| :--- | :--- | :--- |
| NF-01 | **パフォーマンス** | UI操作は即時応答すること。AIの思考中もUIがフリーズしないよう、AIエンジンの処理は非同期に行う。 |
| NF-02 | **セキュリティ** | ユーザーのAPIキーや認証情報を拡張機能内に保存しない。`vscode.lm` APIを利用することでこれを担保する。ファイル操作は現在のワークスペース内に限定する。 |
| NF-03 | **ユーザビリティ** | 専門知識がなくても、直感的なチャット操作で利用を開始できる。エラーメッセージは分かりやすく、次に行うべきアクションを示す。 |
| NF-04 | **信頼性** | Pythonプロセスが予期せず終了した場合、拡張機能はエラーを適切にハンドリングし、ユーザーに通知する。 |
| NF-05 | **拡張性・保守性** | 新しいAIエージェントやツールをPython側で容易に追加・変更できるよう、TS-Python間の通信規約（プロトコル）は汎用的なものにする。 |
| NF-06 | **互換性・依存関係** | 最新バージョンのVS Codeで動作すること。ユーザーが`vscode.lm` APIを提供する拡張機能（例: GitHub Copilot）をインストールしていることを前提とする。未インストールの場合は、その旨を案内する。 |

### **4. システムアーキテクチャ**

#### **4.1. 全体構成図**
```mermaid
graph TD
    subgraph VS Code
        subgraph "CrewAI Connect (TypeScript)"
            A[UI: サイドバー/Webview]
            B[プロセス管理]
            C[LLM Proxy via vscode.lm]
            D[VS Code APIラッパー]
        end
        E[vscode.lm (Copilot等)]
        F[VS Code API (fs, terminal)]
    end

    subgraph "AI Engine (Python)"
        G[CrewAI Framework]
        H[Agents: Planner, Coder, ...]
        I[Custom LLM Class]
        J[Custom Tools]
    end

    A -- ユーザー指示 --> B
    B -- プロセス起動 --> G
    H -- 思考要求 --> I
    I -- LLMリクエスト(JSON) --> B
    B -- sendChatRequest() --> E
    E -- 応答 --> B
    B -- LLM応答(JSON) --> I
    H -- ツール実行要求 --> J
    J -- ツールリクエスト(JSON) --> B
    B -- 実行 --> D
    D -- 実行 --> F
    F -- 結果 --> D
    D -- 結果 --> B
    B -- ツール応答(JSON) --> J
```

#### **4.2. フロントエンド (VS Code拡張機能)**
*   **言語:** TypeScript
*   **責務:** UIの描画、ユーザー入力の受付、Pythonプロセスのライフサイクル管理、`vscode.lm` APIおよびその他VS Code APIの呼び出し。

#### **4.3. バックエンド (AIエンジン)**
*   **言語:** Python
*   **フレームワーク:** CrewAI
*   **責務:** AIエージェントの定義とタスクの実行ロジック。実際の思考やツール実行はフロントエンドへのリクエストとして送出する。

#### **4.4. プロセス間通信 (IPC)**
*   **方式:** `child_process`モジュールを用いてTypeScriptからPythonスクリプトを起動し、標準入出力（stdin/stdout）を介して通信する。
*   **データ形式:** JSON-RPC形式。リクエストとレスポンスには一意のIDを付与し、非同期なやり取りを管理する。

### **5. 用語定義**
| 用語 | 説明 |
| :--- | :--- |
| **AIクルー** | 特定の目標達成のために協調して動作する複数のAIエージェントのチーム。 |
| **AIエージェント** | 特定の役割（例: Coder）とツールを持つ自律的なAI。 |
| **`vscode.lm`** | VS Codeが提供する、IDEに統合されたLLMにアクセスするためのAPI。 |
| **IPC** | Inter-Process Communication (プロセス間通信)。本件ではTypeScriptとPythonプロセス間の通信を指す。 |
| **ワークスペース** | VS Codeで開いているプロジェクトのルートディレクトリ。 |

---